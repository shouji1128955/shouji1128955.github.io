"use strict";(self.webpackChunkbookshell=self.webpackChunkbookshell||[]).push([[2809],{10:(e,a,n)=>{n.r(a),n.d(a,{assets:()=>c,contentTitle:()=>t,default:()=>p,frontMatter:()=>l,metadata:()=>d,toc:()=>i});var r=n(4848),s=n(8453);const l={},t=void 0,d={id:"Sre/\u4e2d\u95f4\u4ef6/databasebackup-restore",title:"databasebackup-restore",description:"1\u3001gitlab\u6570\u636e\u5e93",source:"@site/docs/Sre/2-\u4e2d\u95f4\u4ef6/7.databasebackup-restore.md",sourceDirName:"Sre/2-\u4e2d\u95f4\u4ef6",slug:"/Sre/\u4e2d\u95f4\u4ef6/databasebackup-restore",permalink:"/docs/Sre/\u4e2d\u95f4\u4ef6/databasebackup-restore",draft:!1,unlisted:!1,editUrl:"https://github.com/shouji1128955/bookshell/edit/main/docs/Sre/2-\u4e2d\u95f4\u4ef6/7.databasebackup-restore.md",tags:[],version:"current",lastUpdatedBy:"zhanglaiqiang",lastUpdatedAt:1730043165e3,sidebarPosition:7,frontMatter:{},sidebar:"SreMiddleSoft",previous:{title:"YAPI",permalink:"/docs/Sre/\u4e2d\u95f4\u4ef6/YAPI"},next:{title:"Traefik",permalink:"/docs/Sre/\u4e2d\u95f4\u4ef6/Traefik"}},c={},i=[{value:"1\u3001gitlab\u6570\u636e\u5e93",id:"1gitlab\u6570\u636e\u5e93",level:2},{value:"\u5907\u4efd",id:"\u5907\u4efd",level:3},{value:"\u6062\u590d",id:"\u6062\u590d",level:3},{value:"\u57fa\u4e8e\u6e90\u7801\u5b89\u88c5\u7684\u6062\u590d",id:"\u57fa\u4e8e\u6e90\u7801\u5b89\u88c5\u7684\u6062\u590d",level:3},{value:"2.\u8fbe\u68a6\u6570\u636e\u5e93\u5907\u4efd",id:"2\u8fbe\u68a6\u6570\u636e\u5e93\u5907\u4efd",level:2},{value:"\u5907\u4efd",id:"\u5907\u4efd-1",level:3},{value:"\u6062\u590d",id:"\u6062\u590d-1",level:3},{value:"3\u3001pgsql\u6570\u636e\u5e93",id:"3pgsql\u6570\u636e\u5e93",level:2},{value:"\u5907\u4efd",id:"\u5907\u4efd-2",level:3},{value:"\u6062\u590d",id:"\u6062\u590d-2",level:3},{value:"4\u3001\u91d1\u4ed3\u6570\u636e\u5e93",id:"4\u91d1\u4ed3\u6570\u636e\u5e93",level:2},{value:"\u5907\u4efd",id:"\u5907\u4efd-3",level:3},{value:"\u6062\u590d",id:"\u6062\u590d-3",level:3},{value:"5\u3001Oracle",id:"5oracle",level:2},{value:"\u5907\u4efd",id:"\u5907\u4efd-4",level:3},{value:"\u6062\u590d",id:"\u6062\u590d-4",level:3},{value:"6\u3001\u7985\u9053\u5907\u4efd",id:"6\u7985\u9053\u5907\u4efd",level:2},{value:"\u5907\u4efd",id:"\u5907\u4efd-5",level:3},{value:"\u6062\u590d",id:"\u6062\u590d-5",level:3},{value:"7\u3001jenkins\u6570\u636e\u5907\u4efd",id:"7jenkins\u6570\u636e\u5907\u4efd",level:2},{value:"\u5907\u4efd",id:"\u5907\u4efd-6",level:3},{value:"8\u3001Kvm\u5907\u4efd",id:"8kvm\u5907\u4efd",level:2},{value:"9\u3001yapi",id:"9yapi",level:2},{value:"\u5907\u4efd",id:"\u5907\u4efd-7",level:3},{value:"\u6062\u590d",id:"\u6062\u590d-6",level:3}];function o(e){const a={br:"br",code:"code",h2:"h2",h3:"h3",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",...(0,s.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(a.h2,{id:"1gitlab\u6570\u636e\u5e93",children:"1\u3001gitlab\u6570\u636e\u5e93"}),"\n",(0,r.jsx)(a.h3,{id:"\u5907\u4efd",children:"\u5907\u4efd"}),"\n",(0,r.jsx)(a.p,{children:"\u673a\u5668IP 192.168.1.203\r\n1.1 \u5bbf\u4e3b\u673a\u6570\u636e\u5e93\u76ee\u5f55\r\n/data/qt_gitlab_data/data/backups"}),"\n",(0,r.jsx)(a.p,{children:"1.2 \u5b9a\u65f6\u5907\u4efd\u547d\u4ee4(\u5bbf\u4e3b\u673acrontab)\r\n00 21 * * * docker exec -i 9a7b5170b200  sh /root/gitlabbak.sh  (\u5207\u52ff\u968f\u610f\u6267\u884c)"}),"\n",(0,r.jsx)(a.p,{children:"1.3  \u5bb9\u5668\u4e2d\u5907\u4efd\u7684\u811a\u672c:"}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-shell",children:"[root@beijing-physicalsvr04 backup]# docker exec -i 9a7b5170b200  cat /root/gitlabbak.sh\r\ngitlab-rake gitlab:backup:create\n"})}),"\n",(0,r.jsx)(a.p,{children:(0,r.jsx)(a.img,{src:"https://iteshell.oss-cn-beijing.aliyuncs.com/bookshell/operator/m_ec20494d5ce1f5a87a4ba85313d2f40c_r.png",alt:""})}),"\n",(0,r.jsx)(a.p,{children:"1.4 \u5f02\u5730\u5907\u4efd:"}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-shell",children:"cd  /data/qt_gitlab_data/data/backups\n"})}),"\n",(0,r.jsx)(a.p,{children:"\u5907\u4efd\u6700\u8fd1\u7684\u4e00\u5929\u7684\u6570\u636e\u5305\uff0c\u6bd4\u5982\u5907\u4efd\u50cf\u4e0a\u9762\u5927\u76842023_06_14\u8fd9\u5929\u7684tar\u5305\r\n\u8bf4\u660e\uff1a \u7531\u4e8e\u5907\u4efd\u6587\u4ef6\u6bd4\u8f83\u5927\uff0c\u9700\u8981\u4f7f\u7528xftp \u5de5\u5177\u5907\u4efd\u5373\u53ef"}),"\n",(0,r.jsx)(a.h3,{id:"\u6062\u590d",children:"\u6062\u590d"}),"\n",(0,r.jsxs)(a.p,{children:["\u6570\u636e\u5907\u4efd\u6587\u4ef6:\r\n\u76d8\u9635\u670d\u52a1\u5668192.168.1.205:/backup/devops_backup/gitlab_backup\r\nbackups: \u57fa\u4e8e\u547d\u4ee4\u6062\u590d\u7684\u65b9\u5f0f\r\n",(0,r.jsx)(a.code,{children:"{config,data,logs}:"})," \u57fa\u4e8e\u5907\u4efd\u6587\u4ef6\u6062\u590d\u7684\u65b9\u5f0f-\u4f18\u5148\u63a8\u8350\u6b64\u65b9\u5f0f"]}),"\n",(0,r.jsx)(a.p,{children:"\u57fa\u7840\u955c\u50cf"}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-shell",children:"\r\n192.168.1.207:51888/base/gitlab-ce:12.8.1-ce.0\r\n192.168.1.203:51888/base/gitlab-ce:12.8.1-ce.0\n"})}),"\n",(0,r.jsx)(a.p,{children:"\u521b\u5efa\u6587\u4ef6\u5939"}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-shell",children:"mkdir -p   /data/qt_gitlab_data/\n"})}),"\n",(0,r.jsx)(a.p,{children:"\u79fb\u52a8\u5907\u4efd\u6587\u4ef6"}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-shell",children:"mv  /backup/devops_backup/gitlab_backup/*   /data/qt_gitlab_data/\n"})}),"\n",(0,r.jsx)(a.p,{children:"\u90e8\u7f72\u670d\u52a1"}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-shell",children:"docker service create \\\r\n--hostname git.zlqit.com \\\r\n--network devops \\\r\n--mount type=bind,src=/data/qt_gitlab_data/config,dst=/etc/gitlab \\\r\n--mount type=bind,src=/data/qt_gitlab_data/logs,dst=/var/log/gitlab \\\r\n--mount type=bind,src=/data/qt_gitlab_data/data,dst=/var/opt/gitlab \\\r\n--env GITLAB_OMNIBUS_CONFIG=\"external_url 'http://git.zlqit.com:22280'; gitlab_rails['lfs_enabled'] = true;\" \\\r\n--name qtgit \\\r\n--constraint 'node.labels.role == entry' \\\r\n--label traefik.enable=true \\\r\n--label traefik.http.routers.gitlab.rule=\"Host(\\`git.zlqit.com\\`)\" \\\r\n--label traefik.http.services.gitlab-service.loadbalancer.server.port=22280 \\\r\n 192.168.1.207:51888/base/gitlab-ce:12.8.1-ce.0\n"})}),"\n",(0,r.jsx)(a.h3,{id:"\u57fa\u4e8e\u6e90\u7801\u5b89\u88c5\u7684\u6062\u590d",children:"\u57fa\u4e8e\u6e90\u7801\u5b89\u88c5\u7684\u6062\u590d"}),"\n",(0,r.jsx)(a.p,{children:"\u4fee\u6539\u670d\u52a1\u5668\u7684ssh\u7aef\u53e3\u4e3a2023"}),"\n",(0,r.jsx)(a.p,{children:"\u521b\u5efa\u6587\u4ef6\u76ee\u5f55"}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-shell",children:"mkdir -p /data/web/conf.d\r\nmkdir -p  /data/web/html\r\nmkdir -p /data/web/cert\r\nmkdir -p /data/gitlab/redis\r\nmkdir -p /data/gitlab/postgresql\r\nmkdir -p /data/gitlab/data\n"})}),"\n",(0,r.jsx)(a.p,{children:"\u6302\u8f7d\u6570\u636e\u76d8\u5230/data"}),"\n",(0,r.jsx)(a.p,{children:"\u6267\u884c\u542f\u52a8"}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-shell",children:"docker-compose up\n"})}),"\n",(0,r.jsx)(a.p,{children:"\u62f7\u8d1d\u5907\u4efd\u6587\u4ef6\u5230\u5bb9\u5668"}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-shell",children:"root@new-gitlab:/data# docker cp 1701552136_2023_12_02_11.11.3_gitlab_backup.tar  gitlab:/home/git/data/backups/\n"})}),"\n",(0,r.jsx)(a.p,{children:"\u8fdb\u5165\u5bb9\u5668\u6267\u884c"}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-shell",children:"root@new-gitlab:/data# docker exec -it gitlab bash\r\ncd /home/git/gitlab/vendor\r\nsudo -u git -H bundle exec rake gitlab:backup:restore BACKUP=/home/git/data/backups/1701552136_2023_12_02_11.11.3    RAILS_ENV=production\n"})}),"\n",(0,r.jsx)(a.p,{children:(0,r.jsx)(a.img,{src:"https://iteshell.oss-cn-beijing.aliyuncs.com/bookshell/operator/image-20231210234638640.png",alt:"image-20231210234638640"})}),"\n",(0,r.jsx)(a.p,{children:"\u6062\u590d\u9047\u5230\u7684\u4e00\u4e9b\u9519\u8bef"}),"\n",(0,r.jsx)(a.p,{children:(0,r.jsx)(a.img,{src:"https://iteshell.oss-cn-beijing.aliyuncs.com/bookshell/operator/image-20231210234024392.png",alt:"image-20231210234024392"})}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-shell",children:"sudo -u git -H bundle install --path vendor/bundle\n"})}),"\n",(0,r.jsx)(a.h2,{id:"2\u8fbe\u68a6\u6570\u636e\u5e93\u5907\u4efd",children:"2.\u8fbe\u68a6\u6570\u636e\u5e93\u5907\u4efd"}),"\n",(0,r.jsx)(a.h3,{id:"\u5907\u4efd-1",children:"\u5907\u4efd"}),"\n",(0,r.jsx)(a.p,{children:"2.1 \u5bbf\u4e3b\u673a\u6570\u636e\u5e93\u76ee\u5f55\r\n/data/dm8_data/backup"}),"\n",(0,r.jsx)(a.p,{children:"2.2\u5b9a\u65f6\u5907\u4efd\u547d\u4ee4(\u5bbf\u4e3b\u673acrontab)"}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-shell",children:"\u5bbf\u4e3b\u673a\u5b9a\u65f6\u547d\u4ee4:  00 20 * * * docker exec -i 66e3e7c87a32  sh /root/dm_crontab_bak.sh  (\u5207\u52ff\u968f\u610f\u6267\u884c) \n"})}),"\n",(0,r.jsx)(a.p,{children:"2.3  \u5bb9\u5668\u4e2d\u5907\u4efd\u7684\u811a\u672c:"}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-shell",children:"[root@beijing-physicalsvr04 backup]# docker exec -i 66e3e7c87a32  cat  /root/dm_crontab_bak.sh\r\n#!/bin/bash\r\ncd /opt/dmdbms/bin/\r\nbackup_date=`date +%Y%m%d`\r\n./dexp xxxaaaa/xxxaaaa@localhost:5236 FILE=iteshelldev$backup_date.dmp LOG=iteshelldev$backup_date.log DIRECTORY=/opt/dmdbms/data/backup/ >/dev/null 2>&1\r\n./dexp xxxaaaa/xxxaaaa@localhost:5236 FILE=ilync$backup_date.dmp LOG=ilync$backup_date.log DIRECTORY=/opt/dmdbms/data/backup/ >/dev/null 2>&1\r\n./dexp xxxaaaa/xxxaaaa@localhost:5236 FILE=shdb$backup_date.dmp LOG=shdb$backup_date.log DIRECTORY=/opt/dmdbms/data/backup/ >/dev/null 2>&1\r\n./dexp xxxaaaa/xxxaaaa@localhost:5236 FILE=iteshelltest$backup_date.dmp LOG=iteshelltest$backup_date.log DIRECTORY=/opt/dmdbms/data/backup/ >/dev/null 2>&1\r\n./dexp xxxaaaaxxxaaaa@localhost:5236 FILE=jbjbjb$backup_date.dmp LOG=jbjbjb$backup_date.log DIRECTORY=/opt/dmdbms/data/backup/ >/dev/null 2>&1\r\n./dexp xxxaaaa/xxxaaaa@localhost:5236 FILE=alerac$backup_date.dmp LOG=alerac$backup_date.log DIRECTORY=/opt/dmdbms/data/backup/ >/dev/null 2>&1\n"})}),"\n",(0,r.jsx)(a.p,{children:"2.4 \u5f02\u5730\u5907\u4efd:"}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-shell",children:"1.\u5bfc\u51fa\u6700\u8fd1\u4e00\u6b21\u6570\u636e\u5907\u4efd\u6587\u4ef6\r\ncd /data/dm8_data/backup\r\nls -lrt | grep -E  \"iteshellde|ilync|shdb|iteshelltest|jbjbjb|alerac\" | awk '{print $NF}' | tail -n 14 > td.txt\n"})}),"\n",(0,r.jsx)(a.p,{children:"2.\u521b\u5efa\u4e34\u76ee\u5f55(\u7b2c\u4e00\u6b21\u9700\u8981\uff0c\u540e\u7eed\u53ef\u4ee5\u7701\u7565)\r\nmkdir tmp"}),"\n",(0,r.jsxs)(a.ol,{start:"3",children:["\n",(0,r.jsx)(a.li,{children:"\u79fb\u52a8\u5907\u4efd\u6587\u4ef6\u5230\u4e34\u65f6\u76ee\u5f55"}),"\n"]}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-shell",children:"for i in `cat td.txt `; do mv $i ./tmp/ ; done\n"})}),"\n",(0,r.jsxs)(a.ol,{start:"4",children:["\n",(0,r.jsx)(a.li,{children:"\u6253\u5f00ftp\u5907\u4efd\u4e0b\u9762\u76ee\u5f55\u7684\u6570\u636e"}),"\n"]}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-shell",children:"/data/pg_data/data/backup/tmp\n"})}),"\n",(0,r.jsx)(a.p,{children:"5.\u628a\u4e34\u65f6\u5907\u4efd\u6570\u636e\u8fd8\u539f\u5230\u539f\u6765\u7684\u6570\u636e\u76ee\u5f55"}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-shell",children:"mv ./tmp/*  .\n"})}),"\n",(0,r.jsx)(a.h3,{id:"\u6062\u590d-1",children:"\u6062\u590d"}),"\n",(0,r.jsxs)(a.p,{children:["2.1 \u5bb9\u5668\u6062\u590d\u9a8c\u8bc1\u65b9\u5f0f\r\n\u955c\u50cf\r\ndm8_single",":v8",".1.2.128_ent_x86_64_ctm_pack4\r\n192.168.1.203:51888/base/dm8_single",":v8",".1.2.128_ent_x86_64_ctm_pack4\r\n192.168.1.207:51888/base/dm8_single",":v8",".1.2.128_ent_x86_64_ctm_pack4"]}),"\n",(0,r.jsx)(a.p,{children:"\u521b\u5efa\u65b9\u5f0f-\u7814\u53d1\u73af\u5883\u90e8\u7f72\u65b9\u5f0f\r\n\u5c06\u5907\u4efd\u7684\u6570\u636e\u653e\u5230\u5bf9\u5e94\u7684\u76ee\u5f55\r\n\u670d\u52a1\u5668: 192.168.1.205:/backup/db_backup/dm8_backup/backup/daily"}),"\n",(0,r.jsx)(a.p,{children:"6.1.1 \u5728\u9700\u8981\u6062\u590d\u7684\u670d\u52a1\u5668\u521b\u5efa\u6587\u4ef6\u5939"}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-shell",children:"mkdir -p  /data/dm8_data\n"})}),"\n",(0,r.jsx)(a.p,{children:"6.1.2 \u590d\u5236\u5907\u4efd\u6587\u4ef6\u5230\u5bf9\u5e94\u7684\u6570\u636e\u76ee\u5f55,\u5047\u5982 alerac20230709.dmp \u662f\u6700\u8fd1\u4e00\u6b21\u7684\u5907\u4efd\r\n\u4e0a\u4f20xxx.dmp\u6587\u4ef6\u5230   /root/"}),"\n",(0,r.jsx)(a.p,{children:"6.1.3 \u4f7f\u7528docker\u90e8\u7f72\u670d\u52a1\r\n#\u521d\u59cb\u5316"}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-shell",children:"docker run -d -p 5236:5236  --name dm8  -e CASE_SENSITIVE=0 -v /data/dm8_data/:/opt/dmdbms/data/  192.168.1.203:51888/base/dm8_single:v8.1.2.128_ent_x86_64_ctm_pack4\r\n#CASE_SENSITIVE\u4e0d\u533a\u5206\u5927\u5c0f\u5199\n"})}),"\n",(0,r.jsx)(a.p,{children:"6.1.4 \u5bfc\u5165\u6570\u636e-\u53d6\u6700\u8fd1\u4e00\u6b21\u6700\u65b0\u7684\u5907\u4efd\u6570\u636e\r\n\u670d\u52a1\u5668\r\n\u6570\u636e\u6240\u5728\u6587\u4ef6\u5939\r\n\u5907\u4efd\u6587\u4ef6-\u7c7b\u4f3c\u4ee5\u4e0b\u6587\u4ef6\r\n192.168.1.205\r\n/backup/db_backup/dm8_backup/backup/daily"}),"\n",(0,r.jsx)(a.p,{children:(0,r.jsx)(a.img,{src:"https://iteshell.oss-cn-beijing.aliyuncs.com/bookshell/operator/m_bddfd1b36ad998d7c14015fe5551c431_r.png",alt:""})}),"\n",(0,r.jsx)(a.p,{children:"6.1.5 \u62f7\u8d1d\u6587\u4ef6\u5230\u5bb9\u5668"}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-shell",children:"docker cp iteshelldev20230719.dmp    dm8:/dm8/dexp/\r\ndocker cp iteshelltest20230719.dmp  dm8:/dm8/dexp/\r\ndocker cp jbjbjb20230719.dmp     dm8:/dm8/dexp/\r\ndocker cp ilync20230719.dmp     dm8:/dm8/dexp/\r\ndocker cp alerac20230719.dmp   dm8:/dm8/dexp/\n"})}),"\n",(0,r.jsx)(a.p,{children:"6.1.6 \u914d\u7f6e\u53d8\u91cf"}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-shell",children:"docker exec -it dm8 bash\r\nvi /etc/profile\r\n\r\nDM_HOME=/opt/dmdbms/\r\nexport PATH=$PATH:$DM_HOME/bin\r\nexport LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$DM_HOME/bin\r\nsource  /etc/profile \n"})}),"\n",(0,r.jsx)(a.p,{children:"6.1.7 \u901a\u8fc7dm\u5ba2\u6237\u7aef\u8fde\u63a5\u6570\u636e\uff0c\u7136\u521b\u5efa\u76f8\u5173\u7528\u6237"}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-shell",children:"create user iteshelldev  identified by test2023;\r\ngrant dba to iteshelldev;\r\n\r\ncreate user iteshelltest  identified by iteshelltest2023;\r\ngrant dba to iteshelltest;\r\n\r\ncreate user jbjbjb  identified by jbjbjb2023;\r\ngrant dba to jbjbjb;\r\n\r\ncreate user ilync  identified by ilync2023;\r\ngrant dba to ilync;\r\n\r\ncreate user alerac  identified by  alerac2023;\r\ngrant dba to alerac;\n"})}),"\n",(0,r.jsx)(a.p,{children:"6.1.8 \u7136\u540e\u5728\u5bb9\u5668\u4e2d\u5bfc\u5165\u6570\u636e\u5373\u53ef"}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-shell",children:"dimp  iteshelldev/iteshelldev2023  directory=/dm8/dexp   file=iteshelldev20230719.dmp      full=y  log=iteshelldev.log \r\ndimp  iteshelltest/iteshelltest2023  directory=/dm8/dexp   file=iteshelltest20230719.dmp   full=y  log=iteshelltest.log\r\ndimp  jbjbjb/jbjbjb2023  directory=/dm8/dexp   file=jbjbjb20230719.dmp         full=y  log=jbjbjb.log\r\ndimp  ilync/ilync2023  directory=/dm8/dexp   file=ilync20230719.dmp         full=y  log=ilync.log\r\ndimp  alerac/alerac2023  directory=/dm8/dexp   file=alerac20230719.dmp   full=y  log=alerac.log\n"})}),"\n",(0,r.jsx)(a.h2,{id:"3pgsql\u6570\u636e\u5e93",children:"3\u3001pgsql\u6570\u636e\u5e93"}),"\n",(0,r.jsx)(a.h3,{id:"\u5907\u4efd-2",children:"\u5907\u4efd"}),"\n",(0,r.jsx)(a.p,{children:"3.1 \u5bbf\u4e3b\u673a\u5907\u4efd\u76ee\u5f55\r\n/data/pg_data/data/backup"}),"\n",(0,r.jsx)(a.p,{children:"3.2 \u5b9a\u65f6\u5907\u4efd\u547d\u4ee4(\u5bbf\u4e3b\u673acrontab)\uff1a"}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-shell",children:"\u5bbf\u4e3b\u673a\u5b9a\u65f6\u547d\u4ee4:   \r\n10 2 * * * docker exec -i 31fdb4cbe63f  sh /root/pgsql_crontab_bak_day.sh\r\n00 2 * * 7 docker exec -i 31fdb4cbe63f  sh /root/pgsql_crontab_bak_week.sh\r\n50 2 30 * * docker exec -i 31fdb4cbe63f  sh /root/pgsql_crontab_bak_month.sh\r\n (\u5207\u52ff\u968f\u610f\u6267\u884c)\n"})}),"\n",(0,r.jsx)(a.p,{children:"3.3  \u5bb9\u5668\u4e2d\u5907\u4efd\u7684\u811a\u672c:"}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-shell",children:"root@31fdb4cbe63f:~# cat pgsql_crontab_bak_day.sh \r\n#!/bin/bash\r\n#cd /opt/dmdbms/bin/\r\nbackup_date=`date +%Y%m%d`\r\npg_dump  -U postgres -c  crhc_iteshell -f   /var/lib/postgresql/data/backup/daily/crhc_iteshell$backup_date.sql\r\npg_dump  -U postgres -c maomei  -f   /var/lib/postgresql/data/backup/daily/maomei$backup_date.sql\r\nroot@31fdb4cbe63f:~# cat pgsql_crontab_bak_week.sh \r\n#!/bin/bash\r\n#cd /opt/dmdbms/bin/\r\nbackup_date=`date +%Y%m%d`\r\npg_dump  -U postgres -c dev_heabei_gasu  -f   /var/lib/postgresql/data/backup/weekly/dev_hebei_gasu$backup_date.sql\r\npg_dump  -U postgres -c dome_gyjftgasu  -f   /var/lib/postgresql/data/backup/weekly/dome_gyjtgasu$backup_date.sql\r\npg_dump  -U postgres -c test_itesshellgh  -f   /var/lib/postgresql/data/backup/weekly/test_iteshellgh$backup_date.sql\r\npg_dump  -U postgres -c test_hbsfz  -f   /var/lib/postgresql/data/backup/weekly/test_hbfz$backup_date.sql\r\npg_dump  -U postgres -c test_hednan_gasu  -f   /var/lib/postgresql/data/backup/weekly/test_henan_gasu$backup_date.sql\r\npg_dump  -U postgres -c test_hldjgasudb  -f   /var/lib/postgresql/data/backup/weekly/test_hljgasudb$backup_date.sql\r\npg_dump  -U postgres -c test_hnssdb  -f   /var/lib/postgresql/data/backup/weekly/test_hndb$backup_date.sql\r\npg_dump  -U postgres -c fanruanfReport  -f   /var/lib/postgresql/data/backup/weekly/fanruanReport$backup_date.sql\r\nroot@31fdb4cbe63f:~# cat pgsql_fcrontab_bak_month.sh \r\n#!/bin/bash\r\n#cd /opt/dmdbms/bin/\r\nbackup_date=`date +%Y%m%d`\r\npg_dump  -U postgres -c test_hebei_gasu  -f   /var/lib/postgresql/data/backup/monthly/test_hebei_gasu$backup_date.sql\r\npg_dump  -U postgres -c test_hlj_tz  -f   /var/lib/postgresql/data/backup/monthly/test_hlj_tz$backup_date.sql\r\npg_dump  -U postgres -c test_lngasu_gasu  -f   /var/lib/postgresql/data/backup/monthly/test_lngasu_gasu$backup_date.sql\n"})}),"\n",(0,r.jsx)(a.p,{children:"3.4 \u5f02\u5730\u5907\u4efd:"}),"\n",(0,r.jsxs)(a.ol,{children:["\n",(0,r.jsx)(a.li,{children:"\u5bfc\u51fa\u6700\u8fd1\u4e00\u6b21\u6570\u636e\u5907\u4efd\u6587\u4ef6"}),"\n"]}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-shell",children:"cd /data/pg_data/data/backup\r\nls -lrt | grep -E  \"aa|dev_hebeia_gasu|dev_hlj_tz|dev_hndb|dome_gyjtgasu|test_iteshellgh|test_hbfz|test_hebei_gasu|test_henan_gasu|test_hlj_tz|test_hljgasudb|test_hndb|maomei|fanruanReport\" | awk '{print $NF}' | tail -n 14 > db.txt\n"})}),"\n",(0,r.jsx)(a.p,{children:"2.\u521b\u5efa\u4e34\u76ee\u5f55(\u7b2c\u4e00\u6b21\u9700\u8981\uff0c\u540e\u7eed\u53ef\u4ee5\u7701\u7565)"}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-shell",children:"mkdir tmp\n"})}),"\n",(0,r.jsxs)(a.ol,{start:"3",children:["\n",(0,r.jsx)(a.li,{children:"\u79fb\u52a8\u5907\u4efd\u6587\u4ef6\u5230\u4e34\u65f6\u76ee\u5f55"}),"\n"]}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-shell",children:"for i in `cat td.txt `; do mv $i ./tmp/ ; done\n"})}),"\n",(0,r.jsxs)(a.ol,{start:"4",children:["\n",(0,r.jsx)(a.li,{children:"\u6253\u5f00ftp\u5907\u4efd\u4e0b\u9762\u76ee\u5f55\u7684\u6570\u636e"}),"\n"]}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-shell",children:"/data/pg_data/data/backup/tmp\n"})}),"\n",(0,r.jsx)(a.p,{children:"5.\u628a\u4e34\u65f6\u5907\u4efd\u6570\u636e\u8fd8\u539f\u5230\u539f\u6765\u7684\u6570\u636e\u76ee\u5f55"}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-shell",children:"mv ./tmp/*  .\n"})}),"\n",(0,r.jsx)(a.h3,{id:"\u6062\u590d-2",children:"\u6062\u590d"}),"\n",(0,r.jsx)(a.p,{children:"3.5 \u5bb9\u5668\u6062\u590d\u9a8c\u8bc1\u53ca\u6570\u636e\u6062\u590d\u9a8c\u8bc1\r\n/backup/db_backup/pgsql_backup/\u6b64\u76ee\u5f55\u4e3a\u6570\u636e\u6301\u4e45\u5316\u76ee\u5f55\u53ca\u6570\u636e\u5907\u4efd\u76ee\u5f55"}),"\n",(0,r.jsx)(a.p,{children:"3.5.1\u3001\u62c9\u53d6postgresql\u7684\u955c\u50cf\u53ca\u670d\u52a1\u542f\u52a8\r\ndocker pull 192.168.1.203:51888/git/postgres:13.2"}),"\n",(0,r.jsx)(a.p,{children:"#\u5c06\u6570\u636e\u6301\u4e45\u5316\u76ee\u5f55/backup/db_backup/pgsql_backup/\u5f80\u670d\u52a1\u5668\u4e0acp\u4e00\u4efd\u7136\u540e\u7528\u4e8e\u6570\u636e\u6301\u4e45\u5316\u76ee\u5f55\u8fdb\u884c\u542f\u52a8\u5bb9\u5668"}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-shell",children:"docker run -dit -p 5432:5432 --restart=always -v /data/pgsql_data/data/:/var/lib/postgresql/data/ --name pgsql 192.168.1.203:51888/git/postgres:13.2\n"})}),"\n",(0,r.jsx)(a.p,{children:"3.5.2\u3001\u6570\u636e\u96c6\u6062\u590d\u547d\u4ee4\u5982\u4e0b"}),"\n",(0,r.jsx)(a.p,{children:"1)\u3001\u521b\u5efa\u6570\u636e\u5e93\u5b9e\u4f8b"}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-shell",children:"create database test_henan_gasu;\r\ncreate database test_hljgasudb;\r\ncreate database dev_hebei_gasu;\r\ncreate database test_hebei_gasu;\r\ncreate database test_hlj_tz;\r\ncreate database test_iteshellgh;\r\ncreate database dome_gyjtgasu;\r\ncreate database test_hndb;\r\ncreate database test_hbfz;\r\ncreate database test_lngasu_gasu;\r\ncreate database crhc_iteshell;\r\ncreate database fanruanReport;\r\ncreate database maomei;\n"})}),"\n",(0,r.jsx)(a.p,{children:"2)\u3001\u6570\u636e\u5bfc\u5165"}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-shell",children:"psql  -d  test_henan_gasu -f  /var/lib/postgresql/backup/weekly/test_henan_gasu20230729.sql postgres\r\npsql  -d  test_hljgasudb -f  /var/lib/postgresql/backup/weekly/test_hljgasudb20230729.sql postgres\r\npsql  -d  dev_hebei_gasu -f  /var/lib/postgresql/backup/weekly/dev_hebei_gasu20230729.sql postgres\r\npsql  -d  test_hebei_gasu -f  /var/lib/postgresql/backup/monthly/test_hebei_gasu20230729.sql postgres\r\npsql  -d  test_hlj_tz -f  /var/lib/postgresql/backup/monthly/test_hlj_tz20230729.sql postgres\r\npsql  -d  test_iteshellgh -f  /var/lib/postgresql/backup/weekly/test_iteshellgh20230729.sql postgres\r\npsql  -d  dome_gyjtgasu -f  /var/lib/postgresql/backup/weekly/dome_gyjtgasu20230729.sql postgres\r\npsql  -d  test_hndb -f  /var/lib/postgresql/backup/weekly/test_hndb20230729.sql postgres\r\npsql  -d  test_hbfz -f  /var/lib/postgresql/backup/weekly/test_hhbfz20230729.sql postgres\r\npsql  -d  test_lngasu_gasu -f  /var/lib/postgresql/backup/monthly/test_lngasu_gasu20230729.sql postgres\r\npsql  -d  crhc_iteshell -f  /var/lib/postgresql/backup/daily/crhc_iteshell20230729.sql postgres\r\npsql  -d  fanruanReport -f  /var/lib/postgresql/backup/weekly/fanruanReport20230729.sql postgres\r\npsql  -d  maomei -f  /var/lib/postgresql/backup/daily/maomei20230729.sql postgres\r\n\n"})}),"\n",(0,r.jsx)(a.p,{children:"\u4f7f\u7528navicat\u767b\u5f55\u4e0a\u4e4b\u540e\u68c0\u67e5\u5404\u6570\u636e\u5e93\u670d\u52a1\u7684\u6570\u636e\u662f\u5426\u6b63\u5e38\u5373\u53ef;"}),"\n",(0,r.jsx)(a.h2,{id:"4\u91d1\u4ed3\u6570\u636e\u5e93",children:"4\u3001\u91d1\u4ed3\u6570\u636e\u5e93"}),"\n",(0,r.jsx)(a.h3,{id:"\u5907\u4efd-3",children:"\u5907\u4efd"}),"\n",(0,r.jsx)(a.p,{children:"4.1 \u5bbf\u4e3b\u673a\u5907\u4efd\u76ee\u5f55\r\n/data/kingbase_data/backup"}),"\n",(0,r.jsx)(a.p,{children:"4.2 \u5b9a\u65f6\u5907\u4efd\u547d\u4ee4(\u5bbf\u4e3b\u673acrontab)\uff1a\r\n\u5bbf\u4e3b\u673a\u5b9a\u65f6\u547d\u4ee4:"}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-shell",children:"30 20 * * * docker exec -i 238b7890f4ec  sh /root/kingbase_crontab_bak.sh   (\u5207\u52ff\u968f\u610f\u6267\u884c) \n"})}),"\n",(0,r.jsx)(a.p,{children:"4.3  \u5bb9\u5668\u4e2d\u5907\u4efd\u7684\u811a\u672c:"}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-shell",children:"[root@beijing-physicalsvr04 backup]# docker exec -i 238b7890f4ec  cat /root/kingbase_crontab_bak.sh\r\n#!/bin/bash\r\ncd /home/test/KingbaseES/bin/\r\nbackup_date=`date +%Y%m%d`\r\n./sys_dump -h 127.0.0.1 -p 54321 -U iteshelldev -W iteshelldev2023 -F c -f /home/kingbase/ES/V8/data/backup/iteshelldev$backup_date.dmp iteshelldev\r\n./sys_dump -h 127.0.0.1 -p 54321 -U iteshelltest -W iteshelltest2023 -F c -f /home/kingbase/ES/V8/data/backup/iteshelltest$backup_date.dmp iteshelltest\r\n./sys_dump -h 127.0.0.1 -p 54321 -U jsiteshell -W jsiteshell2023 -F c -f /home/kingbase/ES/V8/data/backup/jsiteshell$backup_date.dmp jsgasuxt\n"})}),"\n",(0,r.jsx)(a.p,{children:"4.4 \u5f02\u5730\u5907\u4efd:\r\n1.\u5bfc\u51fa\u6700\u8fd1\u4e00\u6b21\u6570\u636e\u5907\u4efd\u6587\u4ef6"}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-shell",children:"cd /data/kingbase_data/backup\r\nls -lrt | grep -E  \"iteshelldev2023|iteshelltest2023|jsiteshell2023\" | awk '{print $NF}' | tail -n 3 >td.txt\n"})}),"\n",(0,r.jsx)(a.p,{children:"2.\u521b\u5efa\u4e34\u76ee\u5f55(\u7b2c\u4e00\u6b21\u9700\u8981\uff0c\u540e\u7eed\u53ef\u4ee5\u7701\u7565)"}),"\n",(0,r.jsx)(a.p,{children:"mkdir tmp"}),"\n",(0,r.jsx)(a.p,{children:"3.\u79fb\u52a8\u5907\u4efd\u6587\u4ef6\u5230\u4e34\u65f6\u76ee\u5f55"}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-shell",children:"for i in `cat td.txt `; do mv $i ./tmp/ ; done\n"})}),"\n",(0,r.jsx)(a.p,{children:"4.\u6253\u5f00ftp\u5907\u4efd\u6570\u636e"}),"\n",(0,r.jsx)(a.p,{children:"5.\u628a\u4e34\u65f6\u5907\u4efd\u6570\u636e\u8fd8\u539f\u5230\u539f\u6765\u7684\u6570\u636e\u76ee\u5f55"}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-shell",children:"mv ./tmp/*  .\n"})}),"\n",(0,r.jsx)(a.h3,{id:"\u6062\u590d-3",children:"\u6062\u590d"}),"\n",(0,r.jsx)(a.p,{children:"\u5bb9\u5668\u6062\u590d\u9a8c\u8bc1\u65b9\u5f0f"}),"\n",(0,r.jsxs)(a.p,{children:["\u8001\u955c\u50cf-\u4e0d\u63a8\u8350\u4f7f\u7528\r\nkdb_case_sensitive_centos7.5_x86_64_v8r3c02b0370",":v1","\r\n192.168.1.203:51888/base/kdb_case_sensitive_centos7.5_x86_64_v8r3c02b0370",":v1","\r\n192.168.1.207:51888/base/kdb_case_sensitive_centos7.5_x86_64_v8r3c02b0370",":v1"]}),"\n",(0,r.jsxs)(a.p,{children:["\u65b0\u521b\u5efa\u7684\u955c\u50cf-\u4f7f\u7528\u6b64\u955c\u50cf\r\n192.168.1.203:51888/base/kdb_case_sensitive_centos7.5_x86_64_v8r3c02b0370",":v2","\r\n192.168.1.207:51888/base/kdb_case_sensitive_centos7.5_x86_64_v8r3c02b0370",":v2"]}),"\n",(0,r.jsx)(a.p,{children:"\u521b\u5efa\u65b9\u5f0f-\u7814\u53d1\u73af\u5883\u90e8\u7f72\u65b9\u5f0f\r\n\u5c06\u5907\u4efd\u7684\u6570\u636e\u653e\u5230\u5bf9\u5e94\u7684\u76ee\u5f55\r\n\u670d\u52a1\u5668: 192.168.1.205:/backup/db_backup/kingbase_backup/backup/daily"}),"\n",(0,r.jsx)(a.p,{children:"4.1.1 \u5728\u9700\u8981\u6062\u590d\u7684\u670d\u52a1\u5668\u521b\u5efa\u6587\u4ef6\u5939\r\nmkdir -p  /data/kingbase_data\r\n4.1.2 \u590d\u5236\u5907\u4efd\u6587\u4ef6\u5230\u5bf9\u5e94\u7684\u6570\u636e\u76ee\u5f55,\u5047\u5982 alerac20230709.dmp \u662f\u6700\u8fd1\u4e00\u6b21\u7684\u5907\u4efd\r\n\u4e0a\u4f20xxx.dmp\u6587\u4ef6\u5230  /data/kingbase_data"}),"\n",(0,r.jsxs)(a.p,{children:["4.1.3 \u521b\u5efa\u5bb9\u5668\uff0c\u4f46\u4e0d\u9700\u8981\u6302\u8f7d\r\n#\u521d\u59cb\u5316\r\ndocker run  -p 54321:54321  --name kingbasev8r3 ",(0,r.jsx)(a.br,{}),"\n","192.168.1.203:51888/base/kdb_case_sensitive_centos7.5_x86_64_v8r3c02b0370",":v2","\r\n#CASE_SENSITIVE\u4e0d\u533a\u5206\u5927\u5c0f\u5199"]}),"\n",(0,r.jsx)(a.p,{children:"4.1.4 \u5bfc\u5165\u6570\u636e-\u53d6\u6700\u8fd1\u4e00\u6b21\u6700\u65b0\u7684\u5907\u4efd\u6570\u636e\r\n\u670d\u52a1\u5668\r\n\u6570\u636e\u6240\u5728\u6587\u4ef6\u5939\r\n\u5907\u4efd\u6587\u4ef6-\u7c7b\u4f3c\u4ee5\u4e0b\u6587\u4ef6\r\n192.168.1.205\r\n\u6d89\u53ca\u5230\u6570\u636e\u5e93: iteshelldev,iteshelltest\r\n/backup/db_backup/kingbase_backup/backup/daily"}),"\n",(0,r.jsx)(a.p,{children:(0,r.jsx)(a.img,{src:"https://iteshell.oss-cn-beijing.aliyuncs.com/bookshell/operator/m_895c4d2444fa2ea35429907f453e2a83_r.png",alt:""})}),"\n",(0,r.jsx)(a.p,{children:"4.1.5 \u62f7\u8d1d\u6570\u636e\u5e93\u6587\u4ef6\u7cfb\u7edf\u5230\u5bbf\u4e3b\u673a"}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-shell",children:"cd   /data/kingbase_data\r\ndocker cp kingbasev8r3:/home/test/data .\r\nchmod -R 700 /data/kingbase_data/data\r\ndocker rm -f kingbasev8r3\r\n\r\ndocker run  -d -p 54321:54321  --name kingbasev8r3 \\\r\n-v  /data/kingbase_data/data:/home/test/data/ \\\r\n192.168.1.203:51888/base/kdb_case_sensitive_centos7.5_x86_64_v8r3c02b0370:v2\n"})}),"\n",(0,r.jsx)(a.p,{children:"4.1.6 \u67e5\u8be2\u662f\u5426\u4e0d\u533a\u5206\u5927\u5c0f\u5199"}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-shell",children:"docker exec -it kingbasev8r3 bash\r\ncd /home/test/KingbaseES/bin\r\n./ksql -d TEST -U SYSTEM -W 123456\r\nTEST=# show case_sensitive;\r\n case_sensitive \r\n----------------\r\n off\r\n(1 row)\r\n\n"})}),"\n",(0,r.jsx)(a.p,{children:"4.1.7  \u767b\u5f55\u6570\u636e\u5e93-\u6062\u590d\u6570\u636e"}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-shell",children:"\u9ed8\u8ba4\u7528\u6237/\u5bc6\u7801\uff1aSYSTEM/123456\r\ncd /home/test/KingbaseES/bin\r\n./ksql -d TEST -U SYSTEM -W 123456\r\n\r\n-- \u521b\u5efaiteshelldev\u7528\u6237\r\nCREATE USER iteshelldev  PASSWORD 'iteshelldev2023';\r\n-- \u521b\u5efaiteshelldev\u5e93\r\nCREATE DATABASE iteshelldev WITH OWNER = \"iteshelldev\" ENCODING UTF8;\r\n-- \u521b\u5efaschema\r\ncreate schema %s\r\n\r\n-- \u521b\u5efaiteshelltest\u7528\u6237\r\nCREATE USER iteshelltest  PASSWORD 'iteshelltest2023';\r\n-- \u521b\u5efaiteshelltest\u5e93\r\nCREATE DATABASE iteshelltest WITH OWNER = \"iteshelltest\" ENCODING UTF8;\r\n-- \u521b\u5efaschema\r\ncreate schema %s\n"})}),"\n",(0,r.jsx)(a.p,{children:"4.1.8 \u5c06\u903b\u8f91\u5907\u4efd\u6587\u4ef6\u5bfc\u5165\u5bb9\u5668\u4e2d\uff0c\u6307\u5b9a\u76ee\u5f55\u4e3a/root"}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-shell",children:"docker cp iteshelldev20230719.dmp kingbasev8r3:/root/\r\ndocker cp iteshelltest20230719.dmp  kingbasev8r3:/root\n"})}),"\n",(0,r.jsx)(a.p,{children:"4.1.9 \u8fdb\u884c\u6570\u636e\u6062\u590d"}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-shell",children:"docker exec -it kingbasev8r3 bash\r\ncd /home/test/KingbaseES/bin\r\n\u5bfc\u5165\u6570\u636e\uff0c\u8f93\u5165system\u7528\u6237\u540d\u5bc6\u7801\r\n[root@2a866ef87f59 bin]# ./sys_restore   -Fc /root/iteshelldev20230719.dmp  -Usystem  -diteshelldev\r\nPassword: \r\n[root@2a866ef87f59 bin]# ./sys_restore   -Fc /root/iteshelltest20230719.dmp   -Usystem  -diteshelltest\r\nPassword:\n"})}),"\n",(0,r.jsx)(a.p,{children:"\u767b\u5f55\u9a8c\u8bc1\uff0c \u4f7f\u7528\u5ba2\u6237\u7aef\u767b\u5f55\u9a8c\u8bc1\u5373\u53ef"}),"\n",(0,r.jsx)(a.h2,{id:"5oracle",children:"5\u3001Oracle"}),"\n",(0,r.jsx)(a.h3,{id:"\u5907\u4efd-4",children:"\u5907\u4efd"}),"\n",(0,r.jsx)(a.p,{children:"5.1 \u5bbf\u4e3b\u673a\u5907\u4efd\u76ee\u5f55\r\n192.168.1.203:/data/oracle11g_data/helowin/backup"}),"\n",(0,r.jsx)(a.p,{children:"5.2 \u5b9a\u65f6\u5907\u4efd\u547d\u4ee4(\u5bbf\u4e3b\u673acrontab)\uff1a\r\n\u5bbf\u4e3b\u673a\u5b9a\u65f6\u547d\u4ee4:"}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-shell",children:"45 20 * * * docker exec -i 320df33197e2  sh /home/oracle/oracle11g_crontab_bak.sh  (\u5207\u52ff\u968f\u610f\u6267\u884c) \n"})}),"\n",(0,r.jsx)(a.p,{children:"5.3  \u5bb9\u5668\u4e2d\u5907\u4efd\u7684\u811a\u672c:"}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-shell",children:"[root@beijing-physicalsvr04 backup]# docker exec -i 320df33197e2  cat /home/oracle/oracle11g_crontab_bak.sh\r\n#!/bin/bash\r\nsource /etc/profile\r\nbackup_date=`date +%Y%m%d`\r\nexpdp test_yx/test_yx_gasu2023_#@127.0.0.1:1521/helowin directory=datapump_bak dumpfile=yxgasu$backup_date.dmp\r\nexpdp test_salt/test_salt_tz2023_#@127.0.0.1:1521/helowin directory=datapump_bak dumpfile=salt$backup_date.dmp\r\nexpdp test_cnacg_iteshell/test_cnacg_iteshell_2023_#@127.0.0.1:1521/helowin directory=datapump_bak dumpfile=cnacg$backup_date.dmp\n"})}),"\n",(0,r.jsx)(a.p,{children:"5.4 \u5f02\u5730\u5907\u4efd:\r\n1.\u5bfc\u51fa\u6700\u8fd1\u4e00\u6b21\u6570\u636e\u5907\u4efd\u6587\u4ef6"}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-shell",children:"cd /data/oracle11g_data/helowin/backup\r\nls -lrt | grep -E  \"yxgasu|salt|cnacg\" | awk '{print $NF}' | tail -n 3  > td.txt\n"})}),"\n",(0,r.jsx)(a.p,{children:"2.\u521b\u5efa\u4e34\u76ee\u5f55(\u7b2c\u4e00\u6b21\u9700\u8981\uff0c\u540e\u7eed\u53ef\u4ee5\u7701\u7565)\r\nmkdir tmp"}),"\n",(0,r.jsxs)(a.ol,{start:"3",children:["\n",(0,r.jsx)(a.li,{children:"\u79fb\u52a8\u5907\u4efd\u6587\u4ef6\u5230\u4e34\u65f6\u76ee\u5f55"}),"\n"]}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-shell",children:"for i in `cat td.txt `; do mv $i ./tmp/ ; done\n"})}),"\n",(0,r.jsx)(a.p,{children:"4.\u6253\u5f00ftp\u5907\u4efd\u6570\u636e"}),"\n",(0,r.jsx)(a.p,{children:"5.\u628a\u4e34\u65f6\u5907\u4efd\u6570\u636e\u8fd8\u539f\u5230\u539f\u6765\u7684\u6570\u636e\u76ee\u5f55"}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-shell",children:"mv ./tmp/*  .\n"})}),"\n",(0,r.jsxs)(a.p,{children:["\u5907\u4efd\u955c\u50cf\u5730\u5740:",(0,r.jsx)(a.br,{}),"\n","192.168.1.203:18188/base/oracle_11g",":latest","\r\n192.168.1.207:18188/base/oracle_11g",":latest"]}),"\n",(0,r.jsx)(a.h3,{id:"\u6062\u590d-4",children:"\u6062\u590d"}),"\n",(0,r.jsx)(a.h2,{id:"6\u7985\u9053\u5907\u4efd",children:"6\u3001\u7985\u9053\u5907\u4efd"}),"\n",(0,r.jsx)(a.h3,{id:"\u5907\u4efd-5",children:"\u5907\u4efd"}),"\n",(0,r.jsxs)(a.p,{children:["6.1 \u5bbf\u4e3b\u673a\u5907\u4efd\u76ee\u5f55\r\n\u521b\u5efa\u5bb9\u5668\u7ed1\u5b9a\u76ee\u5f55:\r\n",(0,r.jsx)(a.img,{src:"https://iteshell.oss-cn-beijing.aliyuncs.com/bookshell/operator/m_161682817279c826fd90705da4c05132_r.png",alt:""})]}),"\n",(0,r.jsxs)(a.p,{children:["\u6570\u636e\u5e93\u5907\u4efd\uff1a\r\n",(0,r.jsx)(a.img,{src:"https://iteshell.oss-cn-beijing.aliyuncs.com/bookshell/operator/m_a18b37615b2441ea6fb842eefa0259e2_r.png",alt:""})]}),"\n",(0,r.jsxs)(a.p,{children:["6.2 \u5b9a\u65f6\u5907\u4efd\u547d\u4ee4(\u5bbf\u4e3b\u673acrontab)\uff1a\r\n\u5bbf\u4e3b\u673a\u5b9a\u65f6\u547d\u4ee4:",(0,r.jsx)(a.br,{}),"\n","30 6 * * * docker exec -i a9e91a450b1d sh /root/zentao_db_bak.sh\r\n40 6 * * * docker exec -i a9e91a450b1d sh /root/clean_sql.sh\r\n41 6 * * * docker exec -i a9e91a450b1d sh /root/clean_upload.sh"]}),"\n",(0,r.jsx)(a.p,{children:"6.3  \u5bb9\u5668\u4e2d\u5907\u4efd\u7684\u811a\u672czentao_db_bak.sh"}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-shell",children:'[root@beijing-physicalsvr04 data]# docker exec -i 7f71ec8126dc   cat /root/zentao_db_bak.sh\r\n#!/bin/bash\r\nsource /etc/profile\r\nbackup_date=`date +%Y%m%d`\r\nBACK_DIR="/opt/zbox/data/backup"\r\n/opt/zbox/run/mysql/mysqldump  -uroot -h127.0.0.1 -p$PASS  --databases zentao  > ${BACK_DIR}/zentao_db_bak_${backup_date}.sql\r\n/opt/zbox/run/mysql/mysqldump  -uroot -h127.0.0.1 -p$PASS  --databases zentaoep  >  ${BACK_DIR}/zentaoep_db_bak_${backup_date}.sql\r\n/opt/zbox/run/mysql/mysqldump  -uroot -h127.0.0.1 -p$PASS  --databases zentaopro  > ${BACK_DIR}/zentaopro_db_bak_${backup_date}.sql\r\n\r\n###upload backup\r\nbackup_date=`date +%Y%m%d%M`\r\nupload_dir="/opt/zbox/app/zentao/www/data/upload"\r\ncd ${upload_dir}\r\ntar -zcf  ./backup/upload_bak_${backup_date}.tar.gz  --exclude="backup"  ./*\n'})}),"\n",(0,r.jsx)(a.p,{children:'\u6570\u636e\u5e93\u5907\u4efd\u5386\u53f2\u7248\u672c\u548c\u9644\u4ef6\u4fdd\u7559\u811a\u672c\u6837\u4f8b:\r\nback_dir="/opt/zbox/data/backup/"     sql\u5907\u4efd\u76ee\u5f55\r\nback_dir="/opt/zbox/app/zentao/www/data/upload/backup"  upload\u5907\u4efd\u76ee\u5f55'}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-shell",children:'[root@a9e91a450b1d ~]# cat clean_backup.sh  \r\n#!/bin/bash \r\n#\u6b64\u811a\u672c\u7528\u6765\u5b9a\u65f6\u5907\u4efdjenkins_home\u6570\u636e \u5907\u4efd\u6570\u636e\u5b58\u653e\u5728/usr/local/jenkins_backup/\u4e0b\r\nFILE_NAME="zentao_backup"\r\nCOLOR=\'echo -e \\E[01;32m\'\r\nEND=\'\\E[0m\'\r\nback_dir="/opt/zbox/data/backup/"\r\nid_num="9"   ###\u5b9a\u4e49\u5f53\u524d\u4fdd\u7559\u7684\u7248\u672c\r\ncd $data_dir \r\nls -lt $back_dir/  | grep -v total | awk \'{print $9}\' | head -n 4\r\n\r\n\r\nall_file_num=`ls -lt $back_dir/  | grep -v total | awk \'{print $9}\' | wc | awk \'{print $1}\'`\r\nrm_list(){\r\nif [ $all_file_num -gt ${id_num} ]; then \r\n    a=0\r\n    b=0\r\n    c=0\r\n    t=0\r\n    flag=0\r\n    declare -a file_prune_list\r\n\r\n    for list in `ls -lt $back_dir/  | grep -v total | awk \'{print $9}\'` ; do\r\n      all_file_list[$a]=$list\r\n      a=$[a+1]\r\n    done    \r\n\r\n\r\n    #\u9700\u8981\u4fdd\u5b58\u7684\u5386\u53f2\u7248\u672c\r\n    for  list in `ls -lt $back_dir/  | grep -v total | awk \'{print $9}\' | head -n ${id_num}`; do\r\n      save_file_list[$b]=$list \r\n      b=$[b+1]\r\n    done \r\n\r\n    #\u5c06\u4e24\u7ec4\u6587\u4ef6\u5b58\u5165\u5230\u6570\u7ec4\r\n    arry_list1=${all_file_list[@]}\r\n    arry_list2=${save_file_list[@]}\r\n\r\n    for list1_num in "${all_file_list[@]}"\r\n    do \r\n       for list2_num in "${save_file_list[@]}"\r\n       do \r\n           if [[ "${list1_num}" == "${list2_num}" ]]; then \r\n               flag=1\r\n               break \r\n           fi\r\n       done \r\n       if [[ $flag -eq 0 ]]; then \r\n          file_prune_list[t]=$list1_num\r\n          t=$((t+1))\r\n       else\r\n          flag=0 \r\n       fi     \r\n    done  \r\n\r\n\r\n\r\nelse    \r\n  echo "################### \u5f53\u524d\u6587\u4ef6 ${FILE_NAME} \u5386\u53f2\u7248\u672c\u5c0f\u4e8e${id_num}\u4e2a  #####################"\r\n  exit\r\n\r\nfi\r\n\r\nfor i in "${file_prune_list[@]}"; do \r\n     rm -f $back_dir/$i   \r\n    echo "################## \u5220\u9664\u6587\u4ef6  ${FILE_NAME} \u5386\u53f2\u7248\u672c $i #####################"\r\ndone \r\n}\r\nrm_list\r\n\n'})}),"\n",(0,r.jsx)(a.p,{children:"6.4 \u5f02\u5730\u5907\u4efd-\u624b\u52a8:\r\n\u5bfc\u51fa\u9644\u4ef6\r\n1.\u5bfc\u51fa\u6700\u8fd1\u4e00\u6b21\u6570\u636e\u5907\u4efd\u6587\u4ef6"}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-shell",children:"cd  /data/zentao_data/upload/backup\r\nls -lrt | grep -E  \"upload_bak\" | awk '{print $NF}' | tail -n 1  > td.txt\n"})}),"\n",(0,r.jsx)(a.p,{children:"2.\u521b\u5efa\u4e34\u76ee\u5f55(\u7b2c\u4e00\u6b21\u9700\u8981\uff0c\u540e\u7eed\u53ef\u4ee5\u7701\u7565)\r\nmkdir tmp"}),"\n",(0,r.jsx)(a.p,{children:"3.\u79fb\u52a8\u5907\u4efd\u6587\u4ef6\u5230\u4e34\u65f6\u76ee\u5f55"}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-shell",children:"for i in `cat td.txt `; do mv $i ./tmp/ ; done\n"})}),"\n",(0,r.jsx)(a.p,{children:"4.\u6253\u5f00ftp\u5907\u4efd\u6570\u636e"}),"\n",(0,r.jsx)(a.p,{children:"5.\u628a\u4e34\u65f6\u5907\u4efd\u6570\u636e\u8fd8\u539f\u5230\u539f\u6765\u7684\u6570\u636e\u76ee\u5f55\r\nmv ./tmp/*  ."}),"\n",(0,r.jsx)(a.p,{children:"\u5bfc\u51fa\u6570\u636e\u5e93\r\n1.\u5bfc\u51fa\u6700\u8fd1\u4e00\u6b21\u6570\u636e\u5907\u4efd\u6587\u4ef6"}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-shell",children:"cd  /data/zentao_data/data/backup\r\nls -lrt | grep -E  \"zentao_db_bak\" | awk '{print $NF}' | tail -n 1  > td.txt\n"})}),"\n",(0,r.jsx)(a.p,{children:"2.\u521b\u5efa\u4e34\u76ee\u5f55(\u7b2c\u4e00\u6b21\u9700\u8981\uff0c\u540e\u7eed\u53ef\u4ee5\u7701\u7565)\r\nmkdir tmp"}),"\n",(0,r.jsx)(a.p,{children:"3.\u79fb\u52a8\u5907\u4efd\u6587\u4ef6\u5230\u4e34\u65f6\u76ee\u5f55"}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-shell",children:"for i in `cat td.txt `; do mv $i ./tmp/ ; done\n"})}),"\n",(0,r.jsx)(a.p,{children:"4.\u6253\u5f00ftp\u5907\u4efd\u6570\u636e"}),"\n",(0,r.jsx)(a.p,{children:"5.\u628a\u4e34\u65f6\u5907\u4efd\u6570\u636e\u8fd8\u539f\u5230\u539f\u6765\u7684\u6570\u636e\u76ee\u5f55\r\nmv ./tmp/*  ."}),"\n",(0,r.jsx)(a.p,{children:"6.5 \u6570\u636e\u540c\u6b65-rsync\u540c\u6b65\r\n\u4e3b\u673a\r\n\u539f\u6570\u636e\u76ee\u5f55\r\n\u76ee\u6807\u76ee\u5f55\r\n192.168.1.203\r\n/data/zentao_data/\r\n192.168.1.205\r\n/backup/devops_backup/zentao_backup/"}),"\n",(0,r.jsx)(a.h3,{id:"\u6062\u590d-5",children:"\u6062\u590d"}),"\n",(0,r.jsxs)(a.p,{children:["6.1 \u5bb9\u5668\u6062\u590d\u9a8c\u8bc1\r\n\u955c\u50cf\r\nregistry.qt.atme.top:8200/zentao/zentao",":v1",".0\r\n192.168.1.203:18188/base/zentao",":v1",".0\r\n192.168.1.207:18188/base/zentao",":v1",".0"]}),"\n",(0,r.jsx)(a.p,{children:"\u521b\u5efa\u65b9\u5f0f-\u7814\u53d1\u73af\u5883\u90e8\u7f72\u65b9\u5f0f\r\n\u5c06\u5907\u4efd\u7684\u6570\u636e\u653e\u5230\u5bf9\u5e94\u7684\u76ee\u5f55\r\n\u670d\u52a1\u5668: 192.168.1.205:/backup/devops_backup/zentao_backup"}),"\n",(0,r.jsx)(a.p,{children:"6.1.1 \u521b\u5efa\u6587\u4ef6\u5939"}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-shell",children:"mkdir -p  /data/zentao_data/data\r\nmkdir -p  /data/zentao_data/upload\n"})}),"\n",(0,r.jsx)(a.p,{children:"6.1.2 \u590d\u5236\u5907\u4efd\u6587\u4ef6\u5230\u5bf9\u5e94\u7684\u6570\u636e\u76ee\u5f55,upload_bak_2023062530.tar.gz\u662f\u6700\u8fd1\u4e00\u6b21\u7684\u5907\u4efd"}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-shell",children:"tar xf  upload_bak_2023062530.tar.gz -C /data/zentao_data/upload\r\ntar xf  mysql.tar      /data/zentao_data/data   ##\u540e\u9762\u8fdb\u884c\u589e\u91cf\u6570\u636e\u5bfc\u5165\n"})}),"\n",(0,r.jsx)(a.p,{children:"6.1.3 \u4f7f\u7528service\u90e8\u7f72\u670d\u52a1"}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-shell",children:"docker service create --name zentao \\\r\n--network devops \\ \r\n--constraint 'node.labels.role == entry' \\\r\n--mount type=bind,src=/etc/localtime,dst=/etc/localtime \\\r\n--mount type=bind,src=/data/zentao_data/data,dst=/opt/zbox/data \\\r\n--mount type=bind,src=/data/zentao_data/upload,dst=/opt/zbox/app/zentao/www/data/upload \\\r\nregistry.www.zlqit.com:8200/zentao/zentao:v1.0\n"})}),"\n",(0,r.jsx)(a.p,{children:"6.1.4 \u5bfc\u5165\u6570\u636e"}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-shell",children:"docker exec -it  xxxxx bash\r\n/opt/zbox/run/mysql/mysql  -h127.0.0.1 -p123456\r\nMariaDB [zentao]> source /root/zentao_db_bak_20230718.sql\n"})}),"\n",(0,r.jsx)(a.p,{children:"\u5bb9\u5668\u65b9\u5f0f\r\n\u53c2\u8003\u4ee5\u4e0a6.1.1-6.1.2, 6.1.4"}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-shell",children:"docker run  -p 1080:80 --name zentao \\\r\n--mount type=bind,src=/etc/localtime,dst=/etc/localtime \\\r\n--mount type=bind,src=/data/zentao_data/data,dst=/opt/zbox/data \\\r\n--mount type=bind,src=/data/zentao_data/upload,dst=/opt/zbox/app/zentao/www/data/upload \\\r\n192.168.1.203:51888/base/zentao:v1.0\r\n[root@demo112 data]# docker exec -it zentao bash\n"})}),"\n",(0,r.jsx)(a.h2,{id:"7jenkins\u6570\u636e\u5907\u4efd",children:"7\u3001jenkins\u6570\u636e\u5907\u4efd"}),"\n",(0,r.jsx)(a.h3,{id:"\u5907\u4efd-6",children:"\u5907\u4efd"}),"\n",(0,r.jsx)(a.p,{children:"\u8bf4\u660e\uff1a \u7531\u4e8e\u6570\u636e\u6bd4\u8f83\u5927\uff0c\u5927\u7ea640G\u5de6\u53f3\uff0c\u76ee\u524d\u53ea\u4fdd\u7559\u4e24\u4e2a\u5386\u53f2\u7248\u672c\uff0c\u6570\u636e\u5907\u4efd\u4e3a2\u5929\u5907\u4efd\u4e00\u6b21\r\n\u5907\u4efd\u65e5\u671f\u4e3a: \u5468\u4e00\uff0c\u5468\u4e09\uff0c\u5468\u4e94\uff0c\u5468\u65e5\u3002\u51cc\u666800:05\r\n\u670d\u52a1\u5668\u5730\u5740: 192.168.1.204\r\n[root@beijing-virtualsvr01 script]# crontab  -l\r\n5 00 * * 1,3,5,7 bash /opt/script/jenkins_home_backup.sh"}),"\n",(0,r.jsx)(a.p,{children:"\u5907\u4efd\u811a\u672c"}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-shell",children:'[root@beijing-virtualsvr01 script]# cat /opt/script/jenkins_home_backup.sh \r\n#!/usr/bin/bash\r\n#\u6b64\u811a\u672c\u7528\u6765\u5b9a\u65f6\u5907\u4efdjenkins_home\u6570\u636e \u5907\u4efd\u6570\u636e\u5b58\u653e\u5728/data/jenkins/jenkins_backup\u4e0b\r\nFILE_NAME="jenkins_home_databack"\r\ndatetime=`date \'+%Y%m%d%H%M%S\'`\r\ndata_dir="/data/jenkins/.jenkins"\r\nback_dir="/data/jenkins/jenkins_backup"\r\nlog_dir="/var/log"\r\nCOLOR=\'echo -e \\E[01;32m\'\r\nEND=\'\\E[0m\'\r\n$COLOR"########\u6b64\u811a\u672c\u7528\u6765\u5b9a\u65f6\u5907\u4efdjenkins_home\u6570\u636e \u5907\u4efd\u6570\u636e\u5b58\u653e\u5728${back_dir}\u4e0b########"  $END \r\necho "[INFO] ###############`date +%Y-%m-%d_%H:%M:%S`###############" >> ${log_dir}/logout.log\r\necho "[INFO] `date +%Y-%m-%d_%H:%M:%S` \u5907\u4efd\u6570\u636e\u5b58\u653e\u5728${back_dir}" >> ${log_dir}/logout.log\r\n$COLOR"\u8bf7\u7a0d\u540e......"  $END \r\necho "[INFO] `date +%Y-%m-%d_%H:%M:%S`  \u6b63\u5728\u5907\u4efd\u6570\u636e" >> ${log_dir}/logout.log\r\ncd $data_dir \r\ntar cf  $back_dir/${datetime}_jenkins_data.tar.gz  ./* \r\necho "[INFO] `date +%Y-%m-%d_%H:%M:%S` \u5907\u4efd\u5b8c\u6210\uff0c\u5907\u4efd\u6587\u4ef6\u4e3a--\x3e $back_dir/${datetime}_jenkins_data.tar.gz" >> ${log_dir}/logout.log\r\necho "[INFO] `date +%Y-%m-%d_%H:%M:%S` \u5f00\u59cb\u6e05\u7406\u5907\u4efd\u65e7\u6570\u636e" >> ${log_dir}/logout.log\r\nls -lt $back_dir/  | grep -v total | awk \'{print $9}\' | head -n 4\r\n\r\n\r\n###\u5bf9\u5386\u53f2\u7248\u672c\u8fdb\u884c\u5220\u9664\r\nall_file_num=`ls -lt $back_dir/  | grep -v total | awk \'{print $9}\' | wc | awk \'{print $1}\'`\r\nrm_list(){\r\nif [ $all_file_num -gt 3 ]; then \r\n    a=0\r\n    b=0\r\n    c=0\r\n    t=0\r\n    flag=0\r\n    declare -a file_prune_list\r\n\r\n    #\u6240\u6709\u7684\u5386\u53f2\u5907\u4efd\u6587\u4ef6\r\n    for list in `ls -lt $back_dir/  | grep -v total | awk \'{print $9}\'` ; do\r\n      all_file_list[$a]=$list\r\n      a=$[a+1]\r\n    done    \r\n\r\n\r\n    #\u9700\u8981\u4fdd\u5b58\u7684\u5386\u53f2\u7248\u672c\r\n    for  list in `ls -lt $back_dir/  | grep -v total | awk \'{print $9}\' | head -n 3`; do\r\n      save_file_list[$b]=$list \r\n      b=$[b+1]\r\n    done \r\n\r\n    #\u5c06\u4e24\u7ec4\u6587\u4ef6\u5b58\u5165\u5230\u6570\u7ec4\r\n    arry_list1=${all_file_list[@]}\r\n    arry_list2=${save_file_list[@]}\r\n\r\n    for list1_num in "${all_file_list[@]}"\r\n    do \r\n       for list2_num in "${save_file_list[@]}"\r\n       do \r\n           if [[ "${list1_num}" == "${list2_num}" ]]; then \r\n               flag=1\r\n               break \r\n           fi\r\n       done \r\n       if [[ $flag -eq 0 ]]; then \r\n          file_prune_list[t]=$list1_num\r\n          t=$((t+1))\r\n       else\r\n          flag=0 \r\n       fi     \r\n    done  \r\n\r\n\r\n\r\nelse    \r\n  echo "################### \u5f53\u524d\u6587\u4ef6 ${FILE_NAME} \u5386\u53f2\u7248\u672c\u5c0f\u4e8e3\u4e2a  #####################"\r\n  echo "[INFO] `date +%Y-%m-%d_%H:%M:%S`  \u5f53\u524d\u6587\u4ef6 ${FILE_NAME} \u5386\u53f2\u7248\u672c\u5c0f\u4e8e3\u4e2a " >> ${log_dir}/logout.log\r\n  exit\r\n  echo "[INFO] `date +%Y-%m-%d_%H:%M:%S` \u5f53\u524d\u4efb\u52a1\u5df2\u7ed3\u675f" >> ${log_dir}/logout.log\r\nfi\r\n\r\nfor i in "${file_prune_list[@]}"; do \r\n    echo [INFO]\u6b63\u5728\u5220\u9664\u6587\u4ef6  $back_dir/$i\r\n    echo "[INFO] `date +%Y-%m-%d_%H:%M:%S` \u6b63\u5728\u5220\u9664\u6587\u4ef6 $back_dir/$i " >>${log_dir}/logout.log\r\n    rm -f $back_dir/$i\r\n    echo "################## \u5220\u9664\u6587\u4ef6  ${FILE_NAME} \u5386\u53f2\u7248\u672c $i #####################"\r\n    echo "[INFO] `date +%Y-%m-%d_%H:%M:%S` \u5f53\u524d\u4efb\u52a1\u5df2\u7ed3\u675f" >> ${log_dir}/logout.log\r\ndone \r\n}\r\nrm_list\n'})}),"\n",(0,r.jsx)(a.h2,{id:"8kvm\u5907\u4efd",children:"8\u3001Kvm\u5907\u4efd"}),"\n",(0,r.jsx)(a.p,{children:"30 2 * * 1-5  sh /data/script/kvm_snapshot.sh"}),"\n",(0,r.jsx)(a.p,{children:"####\u5feb\u7167\u547d\u4ee4"}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-shell",children:'[root@beijing-physicalsvr04 ~]# cat /data/script/kvm_snapshot.sh \r\nvirsh snapshot-create-as QTCICD  --name  QTCICD_`date +%Y-%m-%d-%H-%M` --description "QTCICD snapshot"\n'})}),"\n",(0,r.jsx)(a.h2,{id:"9yapi",children:"9\u3001yapi"}),"\n",(0,r.jsx)(a.h3,{id:"\u5907\u4efd-7",children:"\u5907\u4efd"}),"\n",(0,r.jsx)(a.p,{children:"yapi\u5907\u4efd\r\n\u673a\u5668: 192.168.1.203\r\nmongodb\u6570\u636e\u5e93\u5907\u4efd\u521b\u5efa\u6587\u4ef6"}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-shell",children:"[root@beijing-physicalsvr04 mongodb]# pwd\r\n/data/yapi_data/mongodb\r\n[root@beijing-physicalsvr04 mongodb]# cat day.sh \r\ndatedir=`date '+%Y%m%d%H'`\r\nmkdir -p /data/db/backup/day/${datedir} -p || true\r\nmongodump -h 127.0.0.1 -u yapi -p yapi1819  --port 27017 --authenticationDatabase admin  -d yapi -o /data/db/backup/day/${datedir}\n"})}),"\n",(0,r.jsx)(a.p,{children:"\u5907\u4efd\u7b56\u7565:\r\n\u6bcf\u96941\u5929\u5907\u4efd\u4e00\u6b21\uff0c 23\uff1a10\u5f00\u59cb\u5907\u4efd\r\n#yapi\u5907\u4efd"}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-shell",children:"10 23 * * * docker exec -i mongodb-yapi  sh /root/day.sh && sleep 20 && mv /data/yapi_data/mongodb/data/backup/day/*   /backup/devops_backup/yapi_backup/day/\n"})}),"\n",(0,r.jsx)(a.p,{children:"\u6570\u636e\u5e93\u521b\u5efa\u65b9\u5f0f\r\n\u76ee\u5f55\uff1a /data/yapi_data/mongodb"}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-shell",children:"[root@beijing-physicalsvr04 mongodb]# cat start.sh \r\n#!/bin/bash\r\nMONGODB_DIR=/data/yapi_data/mongodb\r\ndocker stop mongodb-yapi\r\ndocker rm mongodb-yapi\r\ndocker run -d \\\r\n  --name mongodb-yapi \\\r\n  --restart always \\\r\n  --privileged \\\r\n  -p 27717:27117 \\\r\n  -v ${MONGODB_DIR}/data:/data/db \\\r\n  -e MONGO_INITDB_ROOT_USERNAME=root \\\r\n  -e MONGO_INITDB_ROOT_PASSWORD=aaaaaaaaaa  \\\r\n  192.168.1.203:51888/base/mongo:6.0.6  mongod --auth\r\n\n"})}),"\n",(0,r.jsx)(a.h3,{id:"\u6062\u590d-6",children:"\u6062\u590d"}),"\n",(0,r.jsx)(a.p,{children:"10.1 \u5bb9\u5668\u6062\u590d\u9a8c\u8bc1\r\n\u955c\u50cf\r\n192.168.1.203:18188/base/mongo:6.0.6\r\n192.168.1.207:1818/base/mongo:6.0.6"}),"\n",(0,r.jsx)(a.p,{children:"\u521b\u5efa\u65b9\u5f0f-\u7814\u53d1\u73af\u5883\u90e8\u7f72\u65b9\u5f0f\r\n\u5c06\u5907\u4efd\u7684\u6570\u636e\u653e\u5230\u5bf9\u5e94\u7684\u76ee\u5f55\r\n\u670d\u52a1\u5668: 192.168.1.205:/backup/devops_backup/yapi_backup/day"}),"\n",(0,r.jsx)(a.p,{children:"6.1.1 \u521b\u5efa\u6587\u4ef6\u5939\r\nmkdir -p  /data/yapi_data/mongodb"}),"\n",(0,r.jsx)(a.p,{children:"6.1.2 \u590d\u5236\u5907\u4efd\u6570\u636e\u4e0a\u4f20\u6253\u5230\u6062\u590d\u7684\u670d\u52a1\u5668,\u9700\u8981\u6253\u5305\u6574\u4e2a\u6587\u4ef6\u5939\r\n#\u5728\u4ee5\u4e0b\u670d\u52a1\u5668\u53d6\u6570\u636e"}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-shell",children:"192.168.1.205:/backup/devops_backup/yapi_backup/day\r\ntar zcvf 20230731.tar.gz ./20230732xx\n"})}),"\n",(0,r.jsx)(a.p,{children:"#\u4f20\u5230\u9700\u8981\u6062\u590d\u7684\u673a\u5668\r\nscp 20230731.tar.gz root@xxxxxx:/tmp"}),"\n",(0,r.jsx)(a.p,{children:"##\u8bf4\u660e: 20230731.tar.gz \u662f\u4e3e\u4e2a\u4f8b\u5b50\r\n6.1.3 \u4f7f\u7528docker\u90e8\u7f72\u670d\u52a1"}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-shell",children:"[root@beijing-physicalsvr04 mongodb]# cat start.sh \r\n#!/bin/bash\r\nMONGODB_DIR=/data/yapi_data/mongodb\r\ndocker stop mongodb-yapi\r\ndocker rm mongodb-yapi\r\ndocker run -d \\\r\n  --name mongodb-yapi \\\r\n  --restart always \\\r\n  --privileged \\\r\n  -p 27017:27017 \\\r\n  -v ${MONGODB_DIR}/data:/data/db \\\r\n  -e MONGO_INITDB_ROOT_USERNAME=admin \\\r\n  -e MONGO_INITDB_ROOT_PASSWORD=yapi1819  \\\r\n  192.168.1.203:18188/base/mongo:6.0.6  mongod --auth\n"})}),"\n",(0,r.jsx)(a.p,{children:"6.1.4 \u5bfc\u5165\u6570\u636e"}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-shell",children:"cd  /tmp\r\ntar xf 20230731.tar.gz\r\ndocker cp  20230731  mongodb-yapi:/root/\r\ndocker exec -it mongodb-yapi  bash \r\nmongorestore -u yapi -p yapi1819 --port 27017 --drop --authenticationDatabase admin -d yapi  /root/20230731/yapi\n"})}),"\n",(0,r.jsx)(a.p,{children:"\u76f8\u5173\u64cd\u4f5c"}),"\n",(0,r.jsx)(a.p,{children:"\u67e5\u770b\u6570\u636e\u5e93\r\nshow collections"}),"\n",(0,r.jsx)(a.p,{children:'\u5bfc\u51fa\u6307\u5b9a\u5b57\u6bb5\u7684\u6570\u636e\r\n\u5bfc\u51fa\u5b57\u6bb5"excetion": "\u9884\u8b66\u5f02\u5e38" \u6240\u6709\u7684\u6570\u636e'}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-shell",children:'mongoexport  --host 127.0.0.1  --port 27017 --db sensorcmd --collection new_alarm --query \'{"excetion": "\u9884\u8b66\u5f02\u5e38"}\' --out mongod-new-well-structured-data20231222.json  --type json\n'})}),"\n",(0,r.jsx)(a.p,{children:"\u5bfc\u5165\u6570\u636e"}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{children:"mongoimport --host localhost --port 27017 --db demo --collection col --file mongod-new-well-structured-data20231222.json\n"})}),"\n",(0,r.jsx)(a.p,{children:"\u67e5\u770b\u96c6\u5408\u4e2d\u603b\u7684\u884c\u6570"}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-shell",children:"use your_database_name\r\ndb.your_collection_name.count()\n"})}),"\n",(0,r.jsx)(a.p,{children:"\u5bfc\u51fa\u6307\u5b9a\u6761\u4ef6\u7684\u6570\u636e\r\n\u5982\u679c\u9700\u8981\u5bfc\u51fa\u6ee1\u8db3\u7279\u5b9a\u6761\u4ef6\u7684\u6570\u636e\uff0c\u53ef\u4ee5\u4f7f\u7528--query\u53c2\u6570\u3002\u4ee5\u4e0b\u793a\u4f8b\u5c06\u53ea\u5bfc\u51fa\u5e74\u9f84\u5927\u4e8e30\u7684\u7528\u6237\u6570\u636e\uff1a"}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-shell",children:"mongoexport --host localhost --port 27017 --db mydb --collection users --out users.json --jsonArray --query '{ age: { $gt: 30 } }'\n"})}),"\n",(0,r.jsx)(a.p,{children:"mongo\u5220\u9664\u6307\u5b9a\u7684\u5217"}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-shell",children:'db.your_collection.updateMany({}, { $unset: { "target_field": 1 } });\n'})}),"\n",(0,r.jsx)(a.p,{children:"mongo\u5220\u9664\u591a\u4e2a\u5217"}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-shell",children:'db.your_collection.updateMany({}, { $unset: { "push_desc": 1, "push_person": 1, "push_phone": 1 , "push_time": 1, "record": 1 , "chuzhi_person": 1, "chuzhi_phone": 1, "chuzhi_ts": 1 , "deal_info": 1, "deal_desc": 1, "deal_person": 1, "deal_phone": 1} });\n'})})]})}function p(e={}){const{wrapper:a}={...(0,s.R)(),...e.components};return a?(0,r.jsx)(a,{...e,children:(0,r.jsx)(o,{...e})}):o(e)}},8453:(e,a,n)=>{n.d(a,{R:()=>t,x:()=>d});var r=n(6540);const s={},l=r.createContext(s);function t(e){const a=r.useContext(l);return r.useMemo((function(){return"function"==typeof e?e(a):{...a,...e}}),[a,e])}function d(e){let a;return a=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:t(e.components),r.createElement(l.Provider,{value:a},e.children)}}}]);