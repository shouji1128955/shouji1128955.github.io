"use strict";(self.webpackChunkbookshell=self.webpackChunkbookshell||[]).push([[3613],{1345:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>a,default:()=>p,frontMatter:()=>c,metadata:()=>d,toc:()=>i});var r=n(4848),s=n(8453);const c={},a=void 0,d={id:"k8s/k8s develop/operator",title:"operator",description:"1\u3001\u64cd\u4f5cpod",source:"@site/docs/k8s/k8s develop/1.operator.md",sourceDirName:"k8s/k8s develop",slug:"/k8s/k8s develop/operator",permalink:"/docs/k8s/k8s develop/operator",draft:!1,unlisted:!1,editUrl:"https://github.com/shouji1128955/bookshell/edit/main/docs/k8s/k8s develop/1.operator.md",tags:[],version:"current",lastUpdatedBy:"shouji1128955",lastUpdatedAt:1740846924e3,sidebarPosition:1,frontMatter:{},sidebar:"k8s",previous:{title:"nvidia",permalink:"/docs/k8s/nvidia"},next:{title:"Client-go",permalink:"/docs/k8s/k8s develop/Client-go"}},l={},i=[{value:"1\u3001\u64cd\u4f5cpod",id:"1\u64cd\u4f5cpod",level:2},{value:"1.1\u3001\u6253\u5370\u6240\u6709pod\u4f7f\u7528\u7684\u955c\u50cf",id:"11\u6253\u5370\u6240\u6709pod\u4f7f\u7528\u7684\u955c\u50cf",level:3},{value:"1.2\u3001\u6253\u5370\u6240\u6709ep\u5730\u5740",id:"12\u6253\u5370\u6240\u6709ep\u5730\u5740",level:3},{value:"1.3\u3001\u6e05\u7406\u4e0d\u6b63\u5e38\u7684Pod",id:"13\u6e05\u7406\u4e0d\u6b63\u5e38\u7684pod",level:3},{value:"3\u3001\u8bc1\u4e66\u76f8\u5173",id:"3\u8bc1\u4e66\u76f8\u5173",level:2},{value:"3.1\u3001k8s\u8bc1\u4e66\u8fc7\u671f\u65f6\u95f4\u9a8c\u8bc1",id:"31k8s\u8bc1\u4e66\u8fc7\u671f\u65f6\u95f4\u9a8c\u8bc1",level:3},{value:"3.2\u3001\u66f4\u65b0ingress-tls\u8bc1\u4e66",id:"32\u66f4\u65b0ingress-tls\u8bc1\u4e66",level:3},{value:"3.3\u3001kubernetes\u96c6\u7fa4\u8bc1\u4e66\u66f4\u65b0",id:"33kubernetes\u96c6\u7fa4\u8bc1\u4e66\u66f4\u65b0",level:3},{value:"4\u3001\u955c\u50cf\u5bb9\u5668\u76f8\u5173",id:"4\u955c\u50cf\u5bb9\u5668\u76f8\u5173",level:2},{value:"4.1\u3001\u6e05\u7406k8s\u5404\u4e2a\u8282\u70b9\u7684\u955c\u50cf,\u9700\u8981\u9a8c\u8bc1",id:"41\u6e05\u7406k8s\u5404\u4e2a\u8282\u70b9\u7684\u955c\u50cf\u9700\u8981\u9a8c\u8bc1",level:3},{value:"4.2\u3001patch\u955c\u50cf",id:"42patch\u955c\u50cf",level:3},{value:"4.3\u3001\u5bb9\u5668\u6e05\u7406\u811a\u672c",id:"43\u5bb9\u5668\u6e05\u7406\u811a\u672c",level:3},{value:"4.4\u3001\u66ff\u6362\u5bb9\u5668\u542f\u52a8\u547d\u4ee4",id:"44\u66ff\u6362\u5bb9\u5668\u542f\u52a8\u547d\u4ee4",level:3},{value:"5\u3001\u6301\u4e45\u5316",id:"5\u6301\u4e45\u5316",level:2},{value:"5.1\u3001configmap\u70ed\u66f4\u65b0\u63d2\u4ef6",id:"51configmap\u70ed\u66f4\u65b0\u63d2\u4ef6",level:3},{value:"6\u3001etcd\u76f8\u5173",id:"6etcd\u76f8\u5173",level:2},{value:"6.1\u3001etcd\u64cd\u4f5c",id:"61etcd\u64cd\u4f5c",level:3},{value:"6.2\u3001kubernetes\u4e2detcd\u5907\u4efd\u548c\u6062\u590d",id:"62kubernetes\u4e2detcd\u5907\u4efd\u548c\u6062\u590d",level:3},{value:"8\u3001\u81ea\u52a8\u5316\u5b89\u88c5\u5bb9\u5668",id:"8\u81ea\u52a8\u5316\u5b89\u88c5\u5bb9\u5668",level:2}];function o(e){const t={a:"a",code:"code",h2:"h2",h3:"h3",img:"img",p:"p",pre:"pre",strong:"strong",...(0,s.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(t.h2,{id:"1\u64cd\u4f5cpod",children:"1\u3001\u64cd\u4f5cpod"}),"\n",(0,r.jsx)(t.h3,{id:"11\u6253\u5370\u6240\u6709pod\u4f7f\u7528\u7684\u955c\u50cf",children:"1.1\u3001\u6253\u5370\u6240\u6709pod\u4f7f\u7528\u7684\u955c\u50cf"}),"\n",(0,r.jsx)(t.p,{children:(0,r.jsx)(t.img,{src:"https://iteshell.oss-cn-beijing.aliyuncs.com/bookshell/operator/202411232226594.png",alt:""})}),"\n",(0,r.jsx)(t.h3,{id:"12\u6253\u5370\u6240\u6709ep\u5730\u5740",children:"1.2\u3001\u6253\u5370\u6240\u6709ep\u5730\u5740"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-shell",children:"kubectl get pods --all-namespaces -o=custom-columns=NAME:.metadata.name,Node-IP:.status.hostIP,Pod-IP:.status.podIP | grep 10.0.238.243\n"})}),"\n",(0,r.jsx)(t.h3,{id:"13\u6e05\u7406\u4e0d\u6b63\u5e38\u7684pod",children:"1.3\u3001\u6e05\u7406\u4e0d\u6b63\u5e38\u7684Pod"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-shell",children:'kubectl get pods --all-namespaces | grep Evicted| awk \'{cmd=" kubectl delete pod "$2" -n "$1;system(cmd)}\' \n'})}),"\n",(0,r.jsx)(t.h2,{id:"3\u8bc1\u4e66\u76f8\u5173",children:"3\u3001\u8bc1\u4e66\u76f8\u5173"}),"\n",(0,r.jsx)(t.h3,{id:"31k8s\u8bc1\u4e66\u8fc7\u671f\u65f6\u95f4\u9a8c\u8bc1",children:"3.1\u3001k8s\u8bc1\u4e66\u8fc7\u671f\u65f6\u95f4\u9a8c\u8bc1"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-shell",children:'for item in $(find /etc/kubernetes/pki -maxdepth 2 -name "*.crt"); do\r\n    openssl x509 -enddate -noout -in "$item"\r\n    echo "$item"\r\ndone\n'})}),"\n",(0,r.jsx)(t.h3,{id:"32\u66f4\u65b0ingress-tls\u8bc1\u4e66",children:"3.2\u3001\u66f4\u65b0ingress-tls\u8bc1\u4e66"}),"\n",(0,r.jsx)(t.p,{children:(0,r.jsx)(t.a,{href:"https://iteshell.oss-cn-beijing.aliyuncs.com/bookshell/202401121030436.png",children:"https://iteshell.oss-cn-beijing.aliyuncs.com/bookshell/202401121030436.png"})}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-shell",children:"#\u83b7\u53d6ingress-\u5bf9\u5e94\u7684\u57df\u540d\r\nkubectl  get ingress -A | grep file\r\n\r\n#\u627e\u5230ingress\u4e4b\u540e\uff0c\u67e5\u770b\u7ed1\u5b9a\u7684\u8bc1\u4e66secret \r\nkubectl  get  ingress be-filesystem-api -n smart -o yaml | grep secretName\r\n\r\n#\u521b\u5efa\u8bc1\u4e66-\u63d0\u524d\u5c06\u8bc1\u4e66\u4e0a\u4f20\u5230\u6587\u4ef6\u5939\r\nkubectl  create secret tls be-filesystem-api-tls-20231123 --cert=filesystem-api.aaa.com_bundle.pem --key=filesystem-api.aaa.com.key  --dry-run=client -o yaml > be-filesystem-api-tls-20231123.yaml\r\n\r\n#\u521b\u5efasecret \r\nkubectl  apply -f fe-video-foundation-tls-20231123.yaml\r\n\r\n#\u66ff\u6362secret\r\nkubectl  edit ingress be-filesystem-api -n smart\n"})}),"\n",(0,r.jsx)(t.h3,{id:"33kubernetes\u96c6\u7fa4\u8bc1\u4e66\u66f4\u65b0",children:"3.3\u3001kubernetes\u96c6\u7fa4\u8bc1\u4e66\u66f4\u65b0"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-shell",children:'# k8s\u8bc1\u4e66\u81ea\u52a8\u7eed\u7b7e \r\n0 12 1 4,8,12 * cp -rf /etc/kubernetes /etc/kubernetes.bak;kubeadm certs renew all;mv /etc/kubernetes/*.conf /tmp/;kubeadm init phase kubeconfig all;systemctl restart kubelet;cp /etc/kubernetes/admin.conf ~/.kube/config;docker ps | grep -v pause | grep -E "etcd|scheduler|controller|apiserver" | awk \'{print $1}\' | awk \'{print "docker","restart",$1}\' | bash\n'})}),"\n",(0,r.jsx)(t.h2,{id:"4\u955c\u50cf\u5bb9\u5668\u76f8\u5173",children:"4\u3001\u955c\u50cf\u5bb9\u5668\u76f8\u5173"}),"\n",(0,r.jsx)(t.h3,{id:"41\u6e05\u7406k8s\u5404\u4e2a\u8282\u70b9\u7684\u955c\u50cf\u9700\u8981\u9a8c\u8bc1",children:"4.1\u3001\u6e05\u7406k8s\u5404\u4e2a\u8282\u70b9\u7684\u955c\u50cf,\u9700\u8981\u9a8c\u8bc1"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-shell",children:"for i in `kubectl get nodes -o jsonpath='{range .items[*]}{.status.addresses[0].address}{\"\\n\"}{end}' `; do\r\n    ssh -i XXX USER@$i 'docker image prune -a -f'; exit 0\r\ndone\n"})}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-shell",children:'kubectl get nodes -o jsonpath=\'{range .items[*]}{.status.addresses[?(@.type=="InternalIP")].address}{"\\n"}{end}\'\n'})}),"\n",(0,r.jsx)(t.h3,{id:"42patch\u955c\u50cf",children:"4.2\u3001patch\u955c\u50cf"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-shell",children:'kubectl patch deployment itz-test-aaa   --patch \'{"spec": {"template": {"spec": {"containers": [{"name": "tz-test-aaa-1","image":"harbor.zlqit.com/tz_aaa/tz-test-aaa:1.1.93"}]}}}}\' -n  tz-aaa\n'})}),"\n",(0,r.jsx)(t.h3,{id:"43\u5bb9\u5668\u6e05\u7406\u811a\u672c",children:"4.3\u3001\u5bb9\u5668\u6e05\u7406\u811a\u672c"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-shell",children:"root@ekc10:/home/devops# cat /root/clear/clear_container.sh \r\necho '---------------------------------------------------'\r\necho $(date)\r\ncd /var/lib/docker/containers/\r\ndu -sh * | grep G\r\nfor m in $(du -sh * | grep G | awk -F' ' '{print $1\":\"$2}' | awk -F'G:' '{if ($1 > 5) print $2}')\r\ndo\r\n  for i in $(docker ps -a | awk -F' ' '{print $1}')\r\n  do\r\n    docker inspect $i | grep $m && echo $(docker ps -a | grep $i)\r\n    docker inspect $i | grep $m && echo $(docker ps -a | grep $i) | awk -F' ' '{print $1}' | xargs docker stop | xargs docker rm\r\n  done\r\ndone\n"})}),"\n",(0,r.jsx)(t.h3,{id:"44\u66ff\u6362\u5bb9\u5668\u542f\u52a8\u547d\u4ee4",children:"4.4\u3001\u66ff\u6362\u5bb9\u5668\u542f\u52a8\u547d\u4ee4"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-shell",children:'    command: ["/bin/sh", "-c"]        \r\n    args: ["sleep 1000000"]\n'})}),"\n",(0,r.jsx)(t.p,{children:(0,r.jsx)(t.img,{src:"https://iteshell.oss-cn-beijing.aliyuncs.com/bookshell/operator/202411232233334.png",alt:"image-20231220181249656"})}),"\n",(0,r.jsx)(t.h2,{id:"5\u6301\u4e45\u5316",children:"5\u3001\u6301\u4e45\u5316"}),"\n",(0,r.jsx)(t.h3,{id:"51configmap\u70ed\u66f4\u65b0\u63d2\u4ef6",children:"5.1\u3001configmap\u70ed\u66f4\u65b0\u63d2\u4ef6"}),"\n",(0,r.jsx)(t.p,{children:(0,r.jsx)(t.a,{href:"https://github.com/stakater/Reloader",children:"https://github.com/stakater/Reloader"})}),"\n",(0,r.jsx)(t.h2,{id:"6etcd\u76f8\u5173",children:"6\u3001etcd\u76f8\u5173"}),"\n",(0,r.jsx)(t.h3,{id:"61etcd\u64cd\u4f5c",children:"6.1\u3001etcd\u64cd\u4f5c"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-sh",children:"etcdctl --endpoints=https://127.0.0.1:2379 --cacert=/etc/kubernetes/pki/etcd/ca.crt --cert=/etc/kubernetes/pki/etcd/server.crt --key=/etc/kubernetes/pki/etcd/server.key member remove  chinatelecom-nm07-a100-naster2\r\netcdctl --endpoints=https://127.0.0.1:2379 --cacert=/etc/kubernetes/pki/etcd/ca.crt --cert=/etc/kubernetes/pki/etcd/server.crt --key=/etc/kubernetes/pki/etcd/server.key endpoint health --cluster -w table\r\netcdctl --endpoints 127.0.0.1:2379 --cert=/etc/kubernetes/pki/etcd/server.crt --key=/etc/kubernetes/pki/etcd/server.key --cacert=/etc/kubernetes/pki/etcd/ca.crt snapshot save /var/lib/etcd/etcd_snap_save.db\r\n\r\netcdctl --endpoints=https://127.0.0.1:2379 --cacert=/etc/kubernetes/pki/etcd/ca.crt --cert=/etc/kubernetes/pki/etcd/server.crt --key=/etc/kubernetes/pki/etcd/server.key member list\r\netcdctl --endpoints=https://127.0.0.1:2379 --cacert=/etc/kubernetes/pki/etcd/ca.crt --cert=/etc/kubernetes/pki/etcd/server.crt --key=/etc/kubernetes/pki/etcd/server.key \r\netcdctl --endpoints=https://127.0.0.1:2379 --cacert=/etc/kubernetes/pki/etcd/ca.crt --cert=/etc/kubernetes/pki/etcd/server.crt --key=/etc/kubernetes/pki/etcd/server.key  endpoint health --cluster -w table\r\n\r\n\r\nalias etcdctlnew='etcdctl --endpoints=https://127.0.0.1:2379 --cacert=/etc/kubernetes/pki/etcd/ca.crt --cert=/etc/kubernetes/pki/etcd/server.crt --key=/etc/kubernetes/pki/etcd/server.key'\r\n\r\netcdctlnew member list\r\netcdctlnew  member remove xxxx\n"})}),"\n",(0,r.jsx)(t.h3,{id:"62kubernetes\u4e2detcd\u5907\u4efd\u548c\u6062\u590d",children:"6.2\u3001kubernetes\u4e2detcd\u5907\u4efd\u548c\u6062\u590d"}),"\n",(0,r.jsx)(t.p,{children:(0,r.jsx)(t.strong,{children:"\u5907\u4efd\u65b9\u5f0f"})}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-shell",children:'root@ekc10:/home/devops# cat /data/k8s/etcd_backup/etcd_backup.sh \r\nrm etcd_snap_save_$(date -d "10 days ago" +"%Y%m%d")*\r\n/usr/local/bin/etcdctl --endpoints 127.0.0.1:2379 --cert=/etc/kubernetes/pki/etcd/server.crt --key=/etc/kubernetes/pki/etcd/server.key --cacert=/etc/kubernetes/pki/etcd/ca.crt snapshot save etcd_snap_save_$(date +"%Y%m%d%H%M").db\n'})}),"\n",(0,r.jsx)(t.p,{children:(0,r.jsx)(t.strong,{children:"\u6062\u590d\u65b9\u5f0f"})}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-yaml",children:"## \u5bfc\u51fa\u5de5\u5177\r\nfind /var/lib/containerd -name etcdctl\r\n...\r\n[root@m51 ~]# cp /var/lib/containerd/xxxxx/d4cf2ee0ea5ba2105936897d3d478c38a23ba6fb65593dc808a559e2dc67667a/diff/usr/local/bin/etcdctl /usr/bin/\r\n[root@m51 ~]# etcdctl version\r\netcdctl version: 3.5.3\r\nAPI version: 3.5\r\n\r\n## \u5907\u4efd\r\nETCDCTL_API=3 \\\r\netcdctl \\\r\n--endpoints=<endpoints> \\\r\n--cacert=<trusted-ca-file>  \\\r\n--cert=<cert-file>  \\\r\n--key=<key-file> \\\r\nsnapshot save <backup-file-location>\r\n\r\n## \u8fdb\u884c\u9a8c\u8bc1\r\n[root@m51 etcd-back]# ETCDCTL_API=3 etcdctl --write-out=table snapshot status sn-23-05-24.db\r\n\r\n\u6062\u590d\u547d\u4ee4\r\nETCDCTL_API=3 etcdctl snapshot restore --data-dir /var/lib/etcd/ sn-23-05-24.db\n"})}),"\n",(0,r.jsx)(t.h2,{id:"8\u81ea\u52a8\u5316\u5b89\u88c5\u5bb9\u5668",children:"8\u3001\u81ea\u52a8\u5316\u5b89\u88c5\u5bb9\u5668"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-shell",children:"###\u6309\u7167docker\r\n\r\n#\u6dfb\u52a0GPG key\r\ncurl -fsSL https://mirrors.tuna.tsinghua.edu.cn/docker-ce/linux/ubuntu/gpg | sudo apt-key add -\r\n\r\n#\u9a8c\u8bc1\u6307\u7eb9\r\nsudo apt-key fingerprint 0EBFCD88\r\n\r\n#\u6dfb\u52a0docker-ce\u7684\u4ed3\u5e93\r\nsudo add-apt-repository \\\r\n   \"deb [arch=amd64] https://mirrors.tuna.tsinghua.edu.cn/docker-ce/linux/ubuntu \\\r\n   $(lsb_release -cs) \\\r\n   stable\"\r\n\r\n#\u67e5\u770b\u53ef\u4ee5\u5b89\u88c5\u7684\u7248\u672c\r\napt-cache madison docker \r\napt install docker-ce=5:20.10.10~3-0~ubuntu-focal\r\n\r\n\r\n###\u4fee\u6539containerd\u914d\u7f6e\r\necho \"[info] containerd is already installed\"\r\ndocker_install_code=0\r\nsystemctl  stop ufw && systemctl  disable ufw\r\nrm -f /etc/containerd/config.toml\r\nmkdir -p /etc/containerd\r\ncontainerd config default | tee /etc/containerd/config.toml\r\n\r\nsed -i 's#SystemdCgroup = false#SystemdCgroup = true#' /etc/containerd/config.toml\r\n\r\n\r\nsed -i 's@registry.k8s.io@registry.cn-hangzhou.aliyuncs.com/zlq_registry@'  /etc/containerd/config.toml\r\n\r\nsystemctl daemon-reload\r\nsystemctl restart containerd\r\n\r\n\r\napt-get update\r\nwget https://github.com/kubernetes-sigs/cri-tools/releases/download/v1.23.0/crictl-v1.23.0-linux-amd64.tar.gz\r\ntar zxvf crictl-v1.23.0-linux-amd64.tar.gz -C /usr/local/bin\r\ncat > /etc/crictl.yaml <<EOF\r\nruntime-endpoint: unix:///run/containerd/containerd.sock\r\nimage-endpoint: unix:///run/containerd/containerd.sock\r\ntimeout: 10\r\ndebug: false\r\nEOF\r\n\r\ndocker run --name k8s-manager --net host --restart=always -v /root:/root -d   registry.cn-hangzhou.aliyuncs.com/zlq_registry/k8s-manager:v1.0\n"})})]})}function p(e={}){const{wrapper:t}={...(0,s.R)(),...e.components};return t?(0,r.jsx)(t,{...e,children:(0,r.jsx)(o,{...e})}):o(e)}},8453:(e,t,n)=>{n.d(t,{R:()=>a,x:()=>d});var r=n(6540);const s={},c=r.createContext(s);function a(e){const t=r.useContext(c);return r.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function d(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:a(e.components),r.createElement(c.Provider,{value:t},e.children)}}}]);